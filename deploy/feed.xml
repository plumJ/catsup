<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>plum.J</title>
    <link href="feed.xml" rel="self" />
    <link href="http://plumj.com" />
    <updated>2012-11-04T12:19:00Z</updated>
    <id>http://plumj.com</id>
    
    <entry>
        <title><![CDATA[使用urlopen.read()判断url状态并反馈]]></title>
        <link href="http://plumj.com/2012-10-26-03.html"/>
        <updated>2012-11-04T12:19:00Z</updated>
        <published>2012-11-04T12:19:00Z</published>
        <id>http://plumj.com/2012-10-26-03</id>
        <content type="html">
            <![CDATA[
             <h4>Source Code</h4>
<div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="kn">import</span> <span class="nn">telnetlib</span>

<span class="kn">import</span> <span class="nn">socket</span>



<span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>



<span class="n">expectTime</span> <span class="o">=</span> <span class="mi">5</span> <span class="c"># seconds</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span>

<span class="n">port</span> <span class="o">=</span> <span class="s">&quot;80&quot;</span>

<span class="n">tomcat</span> <span class="o">=</span> <span class="s">&quot;/usr/local/tomcat/&quot;</span>



<span class="k">def</span> <span class="nf">restartlocaltomcat</span><span class="p">():</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;mv /var/log/tomcat_gc.log /var/log/tomcat_gc.log.`date +%Y%m</span><span class="si">%d</span><span class="s">`&quot;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;echo &quot;[`date`] Tomcat now to shutdowning, please wait 10 seconds ..&quot; &gt;&gt; tomcatstatus.log&#39;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">tomcat</span> <span class="o">+</span> <span class="s">&quot;bin/shutdown.sh&quot;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;kill -9 `ps -C java --no-header | awk &#39;{print $1}&#39;`&quot;</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="n">tel</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;echo &quot;[`date`] Shutdown tomcat failed, please shutdown by yourself ..&quot; &gt;&gt; tomcatstatus.log&#39;</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;echo &quot;[`date`] Shutdown tomcat success ..&quot; &gt;&gt; tomcatstatus.log&#39;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;echo &quot;[`date`] Tomcat now to starting ..&quot; &gt;&gt; tomcatstatus.log&#39;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">tomcat</span> <span class="o">+</span> <span class="s">&quot;bin/startup.sh&quot;</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">telnet</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;echo &quot;[`date`] Startup tomcat success ..&quot; &gt;&gt; tomcatstatus.log&#39;</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>

            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;echo &quot;[`date`] Startup tomcat failed ..&quot; &gt;&gt; tomcatstatus.log&#39;</span><span class="p">)</span>



<span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="n">startTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c">#urllib2.urlopen(&quot;http://192.168.10.50/index.html&quot;).read()</span>

        <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://192.168.10.50/search?q=&amp;sort=0&amp;pageSize=4&amp;isQueryTerm=0&amp;sourceId=item.index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">endTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>

        <span class="n">restartlocaltomcat</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

        <span class="k">continue</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">expectTime</span><span class="p">):</span>

        <span class="n">restartlocaltomcat</span><span class="p">()</span>

    <span class="c">#else:</span>

    <span class="c">#   os.system(&#39;echo &quot;[`date`] Tomcat status OK&quot; &gt;&gt; tomcatstatus.log&#39;)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

<h4>How to use</h4>
<div class="highlight"><pre><span class="o">[</span>root@vh1 ~<span class="o">]</span><span class="c"># nohup python checkUrlTomcat.py &amp;</span>
</pre></div>

            ]]>
        </content>
    </entry>
    
    <entry>
        <title><![CDATA[Nginx纯静态化配置 on catsup]]></title>
        <link href="http://plumj.com/2012-10-26-02.html"/>
        <updated>2012-11-04T12:18:47Z</updated>
        <published>2012-11-04T12:18:47Z</published>
        <id>http://plumj.com/2012-10-26-02</id>
        <content type="html">
            <![CDATA[
             <h4>当前配置:</h4>
<div class="highlight"><pre>server {

    listen 80;

    server_name  plumj.com;

    root /usr/local/catsup/deploy;



    add_header     Nginx-Cache     &quot;HIT from plumj.com&quot;;

    add_header     Vary            Accept-Encoding;



    if ($host != &#39;plumj.com&#39;) {

        rewrite ^/(.*)$ http://plumj.com/$1 permanent;

    }



    location ~^/static/ {

            expires 2d;

    }

}
</pre></div>

            ]]>
        </content>
    </entry>
    
    <entry>
        <title><![CDATA[Lucene JVM优化]]></title>
        <link href="http://plumj.com/2012-10-26-01.html"/>
        <updated>2012-11-04T12:18:34Z</updated>
        <published>2012-11-04T12:18:34Z</published>
        <id>http://plumj.com/2012-10-26-01</id>
        <content type="html">
            <![CDATA[
             <h4>优化配置段</h4>
<div class="highlight"><pre><span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;</span>

<span class="s2">-server -Xms3g -Xmx3g -Xmn800m  -XX:PermSize=256m -XX:MaxPermSize=256m -Xnoclassgc -XX:+DisableExplicitGC</span>

<span class="s2">-XX:SurvivorRatio=65536 -XX:MaxTenuringThreshold=0</span>

<span class="s2">-XX:+UseParNewGC</span>

<span class="s2">-XX:+UseConcMarkSweepGC</span>

<span class="s2">-XX:+CMSParallelRemarkEnabled</span>

<span class="s2">-XX:+UseCMSCompactAtFullCollection</span>

<span class="s2">-XX:CMSFullGCsBeforeCompaction=0</span>

<span class="s2">-XX:+UseCMSInitiatingOccupancyOnly</span>

<span class="s2">-XX:CMSInitiatingOccupancyFraction=55</span>

<span class="s2">-XX:+CMSClassUnloadingEnabled</span>



<span class="s2">-XX:+PrintClassHistogram</span>

<span class="s2">-XX:+PrintGCTimeStamps</span>

<span class="s2">-XX:+PrintHeapAtGC</span>

<span class="s2">-XX:+PrintGCApplicationStoppedTime</span>

<span class="s2">-XX:+PrintGCDetails</span>

<span class="s2">-Xloggc:&#39;/var/log/tomcat_gc.log&#39;</span>

<span class="s2">&quot;</span>
</pre></div>

<h4>优化效果，以下是GClog日志</h4>
<div class="highlight"><pre>36673.582: <span class="o">[</span>GC <span class="o">[</span>1 CMS-initial-mark: 1280228K<span class="o">(</span>2326528K<span class="o">)]</span> 1282461K<span class="o">(</span>3145664K<span class="o">)</span>, 0.0020900 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.01 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.00 secs<span class="o">]</span> 

36673.584: <span class="o">[</span>CMS-concurrent-mark-start<span class="o">]</span>

36673.904: <span class="o">[</span>CMS-concurrent-mark: 0.320/0.320 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.88 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.32 secs<span class="o">]</span> 

36673.904: <span class="o">[</span>CMS-concurrent-preclean-start<span class="o">]</span>

36673.921: <span class="o">[</span>CMS-concurrent-preclean: 0.016/0.016 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.04 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.02 secs<span class="o">]</span> 

36673.921: <span class="o">[</span>CMS-concurrent-abortable-preclean-start<span class="o">]</span>

36675.839: <span class="o">[</span>CMS-concurrent-abortable-preclean: 0.348/1.919 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>2.63 <span class="nv">sys</span><span class="o">=</span>0.19, <span class="nv">real</span><span class="o">=</span>1.92 secs<span class="o">]</span> 

36675.840: <span class="o">[</span>GC<span class="o">[</span>YG occupancy: 461341 K <span class="o">(</span>819136 K<span class="o">)]</span>36675.840: <span class="o">[</span>Rescan <span class="o">(</span>parallel<span class="o">)</span> , 0.2238640 secs<span class="o">]</span>36676.064: <span class="o">[</span>weak refs processing, 0.0055360 secs<span class="o">]</span>36676.069: <span class="o">[</span>class unloading, 0.0077180 secs<span class="o">]</span>36676.077: <span class="o">[</span>scrub symbol &amp; string tables, 0.0051810 secs<span class="o">]</span> <span class="o">[</span>1 CMS-remark: 1282623K<span class="o">(</span>2326528K<span class="o">)]</span> 1743964K<span class="o">(</span>3145664K<span class="o">)</span>, 0.2490560 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>1.58 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.25 secs<span class="o">]</span> 

36676.090: <span class="o">[</span>CMS-concurrent-sweep-start<span class="o">]</span>

36679.691: <span class="o">[</span>CMS-concurrent-sweep: 3.535/3.601 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>6.61 <span class="nv">sys</span><span class="o">=</span>0.08, <span class="nv">real</span><span class="o">=</span>3.60 secs<span class="o">]</span> 

36679.691: <span class="o">[</span>CMS-concurrent-reset-start<span class="o">]</span>

36679.698: <span class="o">[</span>CMS-concurrent-reset: 0.007/0.007 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.02 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.01 secs<span class="o">]</span>
</pre></div>

<h4>优化所对应的项目</h4>

<p>Apache Lucene, A flagship sub-project, provides Java-based indexing and search technology.</p>

            ]]>
        </content>
    </entry>
    
</feed>